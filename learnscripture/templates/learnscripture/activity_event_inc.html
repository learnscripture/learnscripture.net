{% load comment_utils %}

  {% with rendered=event.render_html comments=event.comments.all|filter_comments:request_account %}
  {% ifchanged rendered %}
  {% ifchanged event.created.date %}
  <div class="timestamp">
    {{ event.created|date:"j M Y" }}
  </div>
  {% endifchanged %}
  <div class="activityitem" data-event-id="{{ event.id }}">
    <span class="commentindicator">
      <a href="#" class="icon-comment show-add-comment" title="Add comment"><span class="commentcount">{{ comments|length }}</span></a>
    </span>
    <span class="permalink">
      <a href="{{ event.get_absolute_url }}" class="icon-link icon-replace" title="Link directly to this item alone">link</a>
    </span>
    <span class="eventdetails">
      <h4>{{ event.render_html }}</h4>
    </span>
    <div class="commentblock{% if not comments %} hide{% endif %}">
      <div class="commentlist">
        {% for comment in comments %}
        {% include "learnscripture/comment_inc.html" %}
        {% endfor %}
      </div>
      <div><a href="#" class="show-add-comment">Add comment</a></div>
    </div>
  </div>
  {% endifchanged %}
  {% endwith %}
